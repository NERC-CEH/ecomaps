<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:py="http://genshi.edgewall.org/">
<xi:include href="layout.html" />
<head>
    <title>Create Analysis</title>
    <link rel="stylesheet" type="text/css" href="../layout/ecomaps.css"/>
</head>
<body>
    <h1>Create Analysis</h1>

    <div class="row">
        <div class="span12">
            <div class="alert alert-block alert-warning">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                <h4>Be aware!</h4>
                <p>
                    This is some health warning text
                </p>
            </div>
        </div>
    </div>

    <form class="form-horizontal" method="POST" action="${url(controller='analysis', action='create')}">

        <div class="control-group">
            <label for="analysis_name" class="control-label">Name of Analysis:</label>
            ${h.html_tags.text('analysis_name', class_='controls')}
        </div>

        <div class="control-group">
            <label for="coverage_dataset_ids" class="control-label">Choose coverage data:</label>

            <select multiple="true" id="coverage_dataset_ids" name="coverage_dataset_ids" class="controls multiselect">
                <optgroup py:for="dataset in c.coverage_datasets" label="${dataset.name}">
                    <option py:for="column in dataset.column_names" value="${dataset.id}_${column}" py:attrs="{'selected':'True'} if defined('current_coverage_dataset_ids') and '%s_%s' % (dataset.id, column) in current_coverage_dataset_ids else {}">
                        ${column}
                    </option>
                </optgroup>
            </select>

            <i class="icon-info-sign" data-toggle="tooltip" title="A coverage dataset is used to define input data into the model. More than one can be selected"></i>
        </div>

        <div class="control-group">
            <label for="point_dataset_id" class="control-label">Choose point data:</label>

                <select name="point_dataset_id" id="point_dataset_id" class="controls">
                    <option py:for="dataset in c.point_datasets" value="${dataset.id}" py:attrs="{'selected':'True'} if defined('current_point_dataset_id') and dataset.id is current_point_dataset_id else {}">
                        ${dataset.name}
                    </option>
                </select>

            <i class="icon-info-sign" data-toggle="tooltip" title="A point dataset is used to define the spatial grid in the model."></i>
        </div>

        <div class="control-group">
            <label for="unit_of_time" class="control-label">Time Column:</label>

            <select id="unit_of_time" name="unit_of_time" class="controls model-param"></select>

            <i class="icon-info-sign" data-toggle="tooltip" title="Unit of time used in the model."></i>
        </div>

        <div class="control-group">
            <label for="Random Group" class="control-label">Grouping Column:</label>

            <select id="random_group" name="random_group" class="controls model-param"></select>

            <i class="icon-info-sign" data-toggle="tooltip" title="A parameter used to group data in the model."></i>
        </div>

        <div class="control-group">
            <label for="Model Variable" class="control-label">Model Variable Column:</label>

            <select id="model_variable" name="model_variable" class="controls model-param"></select>

            <i class="icon-info-sign" data-toggle="tooltip" title="The variable being modelled"></i>
        </div>

        <div class="control-group">
            <label for="Data Type" class="control-label">Data Type:</label>

            <select class="controls" name="data_type" id="data_type">
                <option value="cont">Continuous</option>
                <option value="count">Count</option>
                <option value="binary">Binary</option>
            </select>

            <i class="icon-info-sign" data-toggle="tooltip" title="Distribution type of the data."></i>
        </div>

        <div class="controls">
            <input type="submit" class="btn btn-primary btn-large pull-right control-group" name="submit" value="Run" />
        </div>
    </form>

<script type="text/javascript" language="JavaScript">
//<![CDATA[
            $(function () {

            var populateVariableList = function(listId, options, defaultValue) {

                listId = "#" + listId;

                $(listId).attr("disabled", false);
                $(listId).empty();

                for(var i=0; i<options.length; i++) {
                    console.log(listId);
                    $(listId).append($("<option></option>")
                        .val(options[i])
                        .text(options[i])
                        .attr("selected", options[i] === defaultValue ? 'selected' : undefined));
                }

            };

            /* updatePointDatasetColumns
            *
            *   Provides a facility for populating the model parameter dropdowns
            *   based on the point dataset chosen
            *
            */
            var updatePointDatasetColumns = function(dataset_id) {

                $("select.model-param").each(function(index){
                    $(this).empty();
                    $(this).append($("<option></option>").text("Loading..."));
                    $(this).attr("disabled", true);
                });

                $.getJSON("/dataset/columns/" + dataset_id,
                    function(data) {

                        // Populate each list we know of

                        // Time
                        populateVariableList("unit_of_time", data, "year");

                        // Group by
                        populateVariableList("random_group", data, "SERIES_NUM");

                        // Model Var
                        populateVariableList("model_variable", data, "loi");
                    });
            };

            // Error span swap
            $("span.help-inline").each(function(index, el){

                // Find the parent control group
                // Swap the message with the input
                $(el).insertAfter($(el).next());
                $(el).closest("div.control-group").addClass("error");
            });

            // Set up handler for changing point dataset value
            $("select#point_dataset_id").change(function(){

                updatePointDatasetColumns($(this).val());
            });

            // Populate the lists based on the currently-selected point dataset
            updatePointDatasetColumns($("select#point_dataset_id option:selected").val());
        })
//]]>
</script>

</body>
</html>